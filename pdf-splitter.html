<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PDF Splitter (All-in-One)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --border:#ddd; --muted:#666; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:780px;margin:40px auto;padding:0 16px}
  header, footer{opacity:.9}
  .card{border:1px solid var(--border);border-radius:12px;padding:16px;background:#fafafa}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  input[type="file"]{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;width:100%}
  button{padding:.65rem 1rem;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#fff}
  button:active{transform:translateY(1px)}
  #split-status{margin-top:10px;color:var(--muted);white-space:pre-wrap}
  .tips{margin-top:14px;border-top:1px dashed var(--border);padding-top:10px}
  code{background:#f0f0f0;padding:0 4px;border-radius:6px}
</style>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<header>
  <h1>PDF Splitter</h1>
  <p>Split a PDF into individual pages (as separate files) or pack them into a single ZIP.</p>
</header>

<main>
  <div class="card">
    <label for="pdf-input"><strong>Select a PDF</strong></label>
    <input type="file" id="pdf-input" accept="application/pdf,.pdf" />

    <div class="row">
      <button id="btn-zip">Split → download ZIP (recommended)</button>
      <button id="btn-perpage">Split → download each page</button>
    </div>

    <p id="split-status"></p>

    <div class="tips">
      <strong>Troubleshooting:</strong>
      <ul>
        <li>If you see <em>“encrypted/password-protected”</em>, unlock the PDF and try again.</li>
        <li>Ensure the <code>pdf-lib</code> and <code>JSZip</code> scripts load (some extensions can block them).</li>
        <li>Prefer serving via a local server, e.g. <code>python3 -m http.server 8080</code> then visit <code>http://localhost:8080/split.html</code>.</li>
        <li>Open DevTools → Console for detailed logs/errors.</li>
      </ul>
    </div>
  </div>
</main>

<footer style="margin-top:24px">
  <p>© 2025 PDF Splitter</p>
</footer>

<script>
(function () {
  // ---------- Utilities ----------
  const delay = (ms) => new Promise((r) => setTimeout(r, ms));
  const log = (...args) => { console.log('[PDF-Splitter]', ...args); };

  function setStatus(msg) {
    const el = document.getElementById('split-status');
    if (el) el.textContent = msg;
  }

  function getEls() {
    const input = document.getElementById('pdf-input');
    if (!input) throw new Error('Missing <input id="pdf-input"> in the page.');
    return { input };
  }

  function checkDeps() {
    const hasPDFLib = !!(window.PDFLib && window.PDFLib.PDFDocument);
    const hasJSZip  = !!window.JSZip;
    if (!hasPDFLib && !hasJSZip) {
      throw new Error('Missing pdf-lib and JSZip. Check CDN script tags.');
    }
    if (!hasPDFLib) throw new Error('Missing pdf-lib. Check CDN script tag.');
    if (!hasJSZip) throw new Error('Missing JSZip. Check CDN script tag.');
  }

  async function loadPdfFromFile(file) {
    const { PDFDocument } = window.PDFLib;
    const buf = await file.arrayBuffer();
    if (!buf || buf.byteLength === 0) {
      throw new Error(`"${file.name}" appears empty or unreadable.`);
    }
    try {
      // Try load even if flagged as encrypted
      return await PDFDocument.load(buf, { ignoreEncryption: true });
    } catch (err) {
      // Truly password-protected
      throw new Error(`"${file.name}" is encrypted/password-protected. Unlock (remove security) and try again.`);
    }
  }

  // ---------- Split: ZIP ----------
  async function splitToZipImpl(pdfDoc, baseName) {
    const JSZip = window.JSZip;
    const { PDFDocument } = window.PDFLib;
    const total = pdfDoc.getPageCount();
    if (total === 0) throw new Error('The PDF has 0 pages.');

    const zip = new JSZip();
    log('Total pages:', total);

    for (let i = 0; i < total; i++) {
      if (i % 10 === 0) await delay(0); // keep UI responsive
      const newDoc = await PDFDocument.create();
      const [page] = await newDoc.copyPages(pdfDoc, [i]);
      newDoc.addPage(page);
      const pdfBytes = await newDoc.save();
      zip.file(`page_${String(i + 1).padStart(3, '0')}.pdf`, pdfBytes);
      setStatus(`Building ZIP… (${i + 1}/${total})`);
    }

    setStatus('Compressing ZIP…');
    const zipBlob = await zip.generateAsync({
      type: 'blob',
      compression: 'DEFLATE',
      compressionOptions: { level: 6 }
    });

    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${baseName}-split_${total}_pages.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setStatus(`✅ ${total} pages split and zipped successfully!`);
  }

  // ---------- Split: Per-Page ----------
  async function splitPerPageImpl(pdfDoc, baseName) {
    const { PDFDocument } = window.PDFLib;
    const total = pdfDoc.getPageCount();
    if (total === 0) throw new Error('The PDF has 0 pages.');

    for (let i = 0; i < total; i++) {
      if (i % 5 === 0) await delay(0); // keep UI responsive
      const newDoc = await PDFDocument.create();
      const [page] = await newDoc.copyPages(pdfDoc, [i]);
      newDoc.addPage(page);
      const pdfBytes = await newDoc.save();

      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${baseName}-page_${String(i + 1).padStart(3, '0')}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(link.href), 0);

      setStatus(`Downloading pages… (${i + 1}/${total})`);
      await delay(200); // helps avoid browser throttling
    }

    setStatus('✅ PDF split completed! All files downloaded.');
  }

  // ---------- Core handler ----------
  async function splitCore(mode /* 'zip' | 'perpage' */) {
    try {
      checkDeps();
    } catch (e) {
      console.error(e);
      setStatus('Error: ' + e.message);
      return;
    }

    const { input } = getEls();
    if (!input.files || input.files.length === 0) {
      setStatus('Select a PDF file first!');
      return;
    }

    const file = input.files[0];
    const baseName = (file.name || 'document').replace(/\.pdf$/i, '') || 'document';

    try {
      setStatus(mode === 'zip' ? 'Preparing to split into ZIP…' : 'Preparing to split into individual files…');
      log('Loading PDF:', file.name, file.size, 'bytes');
      const pdfDoc = await loadPdfFromFile(file);
      const total = pdfDoc.getPageCount();
      log('Loaded PDF pages:', total);

      if (total > 500) {
        setStatus(`Large PDF detected (${total} pages). This may take a while…`);
        await delay(400);
      }

      if (mode === 'zip') {
        await splitToZipImpl(pdfDoc, baseName);
      } else {
        await splitPerPageImpl(pdfDoc, baseName);
      }
    } catch (err) {
      console.error(err);
      setStatus('Error: ' + (err.message || String(err)));
    }
  }

  // ---------- Wire up buttons ----------
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btn-zip')?.addEventListener('click', () => splitCore('zip'));
    document.getElementById('btn-perpage')?.addEventListener('click', () => splitCore('perpage'));
    // Optional: Enter key triggers per-page split
    document.getElementById('pdf-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') splitCore('perpage');
    });
  });
})();
</script>
</body>
</html>
