<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Task Manager ¬∑ HTML/JS</title>
<style>
  :root{
    --bg:#0f172a;
    --app-bg:#f9fafb;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#e5e7eb;
    --overdue:#dc2626;
    --pill:#f3f4f6;
    --pill-border:#e5e7eb;
    --accent:#2563eb;
    --accent-soft:#dbeafe;
    --accent-dark:#1d4ed8;
  }

  *{box-sizing:border-box;}

  html,body{
    margin:0;
    padding:0;
    background:radial-gradient(circle at top,#1d293b,#020617);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:#0f172a;
  }

  .outer{
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:32px 12px;
  }

  .app{
    width:100%;
    max-width:1120px;
    background:var(--app-bg);
    border-radius:18px;
    padding:18px 18px 22px;
    box-shadow:0 18px 45px rgba(15,23,42,.35);
  }

  h1{
    margin:0 0 6px;
    font-size:1.4rem;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .subtitle{
    margin:0 0 12px;
    font-size:.8rem;
    color:var(--muted);
  }

  .tabs{
    display:inline-flex;
    border-radius:999px;
    background:#e5e7eb;
    padding:2px;
    margin-bottom:14px;
  }
  .tab{
    padding:6px 14px;
    border-radius:999px;
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:.85rem;
    color:#374151;
  }
  .tab.active{
    background:#ffffff;
    color:#111827;
    box-shadow:0 1px 4px rgba(15,23,42,.15);
  }

  /* New task card */
  .card{
    background:var(--card);
    border-radius:14px;
    padding:10px 12px 12px;
    border:1px solid var(--border);
    margin-bottom:10px;
  }

  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }
  .card-title{
    font-size:.9rem;
    font-weight:600;
    color:#111827;
  }

  .new-form{
    display:grid;
    grid-template-columns:2.3fr 3fr 1.5fr 1.4fr .9fr;
    gap:6px;
    align-items:center;
  }
  .new-form input,
  .new-form select{
    padding:8px 9px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#ffffff;
    font-size:.85rem;
  }

  .btn{
    padding:7px 11px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f9fafb;
    cursor:pointer;
    font-size:.8rem;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  .btn.primary{
    background:var(--accent);
    border-color:var(--accent-dark);
    color:#ffffff;
  }
  .btn.primary:hover{background:var(--accent-dark);}
  .btn:hover{box-shadow:0 1px 5px rgba(15,23,42,.18);}

  .quick-dates{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
  }
  .quick-label{
    font-size:.78rem;
    color:var(--muted);
    margin-right:2px;
  }
  .quick-chip{
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--pill);
    padding:3px 9px;
    font-size:.78rem;
    cursor:pointer;
  }
  .quick-chip:hover{
    background:var(--accent-soft);
    border-color:var(--accent);
  }

  /* Counts */
  .counts{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    margin:6px 0 4px;
  }
  .counts .pill{
    display:inline-flex;
    align-items:center;
    gap:4px;
    background:#ffffff;
    border-radius:999px;
    border:1px solid var(--border);
    padding:3px 9px;
    font-size:.76rem;
    color:#374151;
  }
  .counts .pill strong{font-weight:600;}

  /* 2-column layout */
  .grid-2{
    display:grid;
    grid-template-columns:1.05fr .95fr;
    gap:10px;
    margin-top:6px;
  }
  .section{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .section-title{
    font-size:.85rem;
    font-weight:600;
    color:#111827;
    margin:2px 0 2px;
  }

  .section-card{
    background:var(--card);
    border-radius:12px;
    border:1px solid var(--border);
    padding:8px 9px;
  }
  .section-card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:4px;
  }
  .section-card-title{
    font-size:.8rem;
    font-weight:600;
  }
  .section-card-sub{
    font-size:.75rem;
    color:var(--muted);
  }

  .empty-text{
    font-size:.78rem;
    color:var(--muted);
    padding:2px 0 2px 2px;
  }

  /* Task row */
  .task-row{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    padding:7px 8px;
    border-radius:10px;
    background:#f9fafb;
    border:1px solid #e5e7eb;
    margin-top:5px;
  }
  .task-row:hover{
    background:#f3f4f6;
    box-shadow:0 1px 4px rgba(15,23,42,.05);
  }

  .task-main{
    flex:1;
    min-width:0;
  }
  .task-title-row{
    display:flex;
    align-items:center;
    gap:6px;
    margin-bottom:2px;
  }
  .task-title{
    font-size:.88rem;
    font-weight:600;
    color:#111827;
    max-width:320px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .task-title.overdue{
    color:var(--overdue);
  }
  .task-meta-pill{
    font-size:.7rem;
    padding:2px 7px;
    border-radius:999px;
    background:#eef2ff;
    color:#3730a3;
  }

  .task-desc{
    font-size:.78rem;
    color:#4b5563;
    max-height:46px;
    overflow:auto;
    padding-right:4px;
    white-space:pre-wrap;
  }

  .task-side{
    flex:0 0 auto;
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
  }
  .task-due-label{
    font-size:.7rem;
    color:var(--muted);
    margin-bottom:1px;
    text-align:right;
  }
  .task-due-input{
    padding:4px 7px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#ffffff;
    font-size:.8rem;
  }

  .task-actions{
    display:flex;
    gap:4px;
  }
  .icon-btn{
    width:26px;
    height:26px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#ffffff;
    cursor:pointer;
    font-size:.8rem;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .icon-btn:hover{
    box-shadow:0 1px 4px rgba(15,23,42,.18);
    background:#f9fafb;
  }

  /* Completed */
  .completed-title{
    text-decoration:line-through;
    color:var(--muted);
  }
  .completed-meta{
    font-size:.75rem;
    color:var(--muted);
  }

  .footer-note{
    margin-top:10px;
    font-size:.76rem;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
  }
  .footer-actions{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }

  @media (max-width:900px){
    .new-form{
      grid-template-columns:1.4fr 2.2fr 1.4fr 1.4fr .9fr;
    }
    .task-title{max-width:220px;}
  }

  @media (max-width:720px){
    .new-form{grid-template-columns:1fr;}
    .grid-2{grid-template-columns:1fr;}
    .task-row{flex-direction:column;align-items:stretch;}
    .task-side{align-items:flex-start;}
    .task-due-label{text-align:left;}
  }
</style>
</head>
<body>
<div class="outer">
  <div class="app">
    <h1>üìù Task Manager</h1>
    <p class="subtitle">Quickly capture, group, and complete tasks with smart dates & recurrence.</p>

    <div class="tabs">
      <button class="tab active" data-tab="pending">‚è≥ Pending</button>
      <button class="tab" data-tab="completed">‚úÖ Completed</button>
    </div>

    <!-- New Task Card -->
    <div class="card" id="newTaskCard">
      <div class="card-header">
        <div class="card-title">Add Task</div>
        <div style="font-size:.75rem;color:var(--muted);">Press <strong>Enter</strong> in title to add for today</div>
      </div>
      <div class="new-form">
        <input id="newTitle" type="text" placeholder="Task title" />
        <input id="newDesc" type="text" placeholder="Short description (optional)" />
        <input id="newDue" type="date" />
        <select id="newRecurrence">
          <option>None</option>
          <option>Daily</option>
          <option>Weekly</option>
          <option>Monthly</option>
        </select>
        <button class="btn primary" id="addBtn" title="Add task">
          <span>Ôºã</span><span>Add</span>
        </button>
      </div>
      <div class="quick-dates">
        <span class="quick-label">Quick dates:</span>
        <button type="button" class="quick-chip" id="qd-today">Today</button>
        <button type="button" class="quick-chip" id="qd-tomorrow">Tomorrow</button>
        <button type="button" class="quick-chip" id="qd-weekend">Weekend</button>
        <button type="button" class="quick-chip" id="qd-nextweek">Next Week</button>
      </div>
    </div>

    <!-- Counters -->
    <div class="counts" id="counts"></div>

    <!-- Pending / Completed containers -->
    <div id="pendingTab">
      <div class="grid-2">
        <div class="section">
          <div class="section-title">Today & This Week</div>

          <div class="section-card">
            <div class="section-card-header">
              <span class="section-card-title">üìÖ Today</span>
            </div>
            <div id="today"></div>
          </div>

          <div class="section-card">
            <div class="section-card-header">
              <span class="section-card-title">üåÖ Tomorrow</span>
            </div>
            <div id="tomorrow"></div>
          </div>

          <div class="section-card">
            <div class="section-card-header">
              <span class="section-card-title">üìÜ This Week</span>
            </div>
            <div class="section-card-sub" id="weekInfo"></div>
            <div id="weekDays"></div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Timeline</div>

          <div class="section-card">
            <div class="section-card-header">
              <span class="section-card-title">‚è∞ Overdue</span>
            </div>
            <div id="overdue"></div>
          </div>

          <div class="section-card">
            <div class="section-card-header">
              <span class="section-card-title">üîÆ Future</span>
            </div>
            <div id="future"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="completedTab" style="display:none">
      <div class="section-title" style="margin-top:4px;">Completed Tasks</div>
      <div class="section-card" id="completedList"></div>
    </div>

    <!-- Hidden file input for restore -->
    <input type="file" id="importFile" accept="application/json" style="display:none" />

    <div class="footer-note">
      <span>Data is stored locally in your browser (and you can backup/restore as JSON).</span>
      <div class="footer-actions">
        <button class="btn" id="btnExport">üíæ Backup JSON</button>
        <button class="btn" id="btnImport">üìÇ Restore JSON</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Utilities ========= */
const lsKey = "taskmgr.tasks.v2";
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function todayDate() {
  const n = new Date();
  return new Date(n.getFullYear(), n.getMonth(), n.getDate());
}

// Date -> yyyy-mm-dd local
function fmtDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

// Parse yyyy-mm-dd to local Date
function parseLocalDate(iso){
  if(!iso) return new Date(NaN);
  const [y,m,d] = iso.split("-").map(n=>parseInt(n,10));
  return new Date(y, (m||1)-1, d||1);
}

const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

function addMonths(d, n=1){
  const nd = new Date(d);
  const day = nd.getDate();
  nd.setDate(1);
  nd.setMonth(nd.getMonth()+n);
  const last = new Date(nd.getFullYear(), nd.getMonth()+1, 0).getDate();
  nd.setDate(clamp(day,1,last));
  return nd;
}

// Saturday of current week
function weekEndSaturday(base){
  const wd = base.getDay(); // Sunday=0..Saturday=6
  const delta = 6 - wd;
  return addDays(base, delta < 0 ? 0 : delta);
}
// Monday of next week
function nextWeekMonday(base){
  const wd = base.getDay(); // Sunday=0..Saturday=6
  const deltaToThisMonday = (1 - wd + 7) % 7;
  const thisMon = addDays(base, deltaToThisMonday);
  return addDays(thisMon, 7);
}

function nextDue(currentISO, rec){
  const d = parseLocalDate(currentISO);
  if(rec==="Daily")  return fmtDate(addDays(d,1));
  if(rec==="Weekly") return fmtDate(addDays(d,7));
  if(rec==="Monthly")return fmtDate(addMonths(d,1));
  return currentISO;
}

/* ========= Data layer ========= */
function loadTasks(){
  try { return JSON.parse(localStorage.getItem(lsKey)) || []; } catch { return []; }
}
function saveTasks(tasks){ localStorage.setItem(lsKey, JSON.stringify(tasks)); }

function newTaskObj({title, description, dueDate, recurrence}){
  const now = new Date();
  return {
    id: crypto.randomUUID(),
    title: title.trim(),
    description: (description||"").trim(),
    dueDate,            // yyyy-mm-dd
    createdAt: now.toISOString(),
    completed: false,
    completedAt: null,
    recurrence: recurrence || "None"
  };
}

/* ========= State ========= */
let tasks = loadTasks();

/* ========= DOM helpers ========= */
function el(tag, opts={}, children=[]){
  const node = document.createElement(tag);
  Object.entries(opts).forEach(([k,v])=>{
    if(k==="class") node.className = v;
    else if(k==="text") node.textContent = v;
    else if(k==="html") node.innerHTML = v;
    else if(k==="title") node.title = v;
    else if(k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
    else node.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(ch => node.appendChild(ch));
  return node;
}

/* ========= Task row components ========= */
function taskRowPending(t){
  const todayISO = fmtDate(todayDate());
  const overdue = t.dueDate < todayISO;

  const titleSpan = el("span", {
    class: "task-title" + (overdue ? " overdue" : ""),
    text: t.title || "(untitled)"
  });
  const repeatText = (t.recurrence && t.recurrence !== "None") ? t.recurrence : "No repeat";
  const repeatPill = el("span",{class:"task-meta-pill", text:repeatText});

  const titleRow = el("div",{class:"task-title-row"},[titleSpan, repeatPill]);

  const descText = (t.description || "").trim() || "‚Äî";
  const descDiv = el("div",{class:"task-desc", text:descText});

  const main = el("div",{class:"task-main"},[titleRow, descDiv]);

  const dueLabel = el("div",{class:"task-due-label", text:"Due date"});
  const dueInput = el("input",{
    class:"task-due-input",
    type:"date",
    value:t.dueDate,
    title:"Change due date"
  });
  dueInput.addEventListener("change", ()=>{
    t.dueDate = dueInput.value || t.dueDate;
    saveTasks(tasks);
    render();
  });

  const btnComplete = el("button",{class:"icon-btn", title:"Mark complete"},[document.createTextNode("‚úî")]);
  btnComplete.addEventListener("click", ()=>{
    if(t.completed) return;
    t.completed = true;
    t.completedAt = new Date().toISOString();
    if(t.recurrence && t.recurrence!=="None"){
      const next = newTaskObj({
        title: t.title,
        description: t.description,
        dueDate: nextDue(t.dueDate, t.recurrence),
        recurrence: t.recurrence
      });
      tasks.push(next);
    }
    saveTasks(tasks);
    render();
  });

  const btnEdit = el("button",{class:"icon-btn", title:"Edit task"},[document.createTextNode("‚úè")]);
  btnEdit.addEventListener("click", ()=>openEditDialog(t));

  const btnDelete = el("button",{class:"icon-btn", title:"Delete task"},[document.createTextNode("üóë")]);
  btnDelete.addEventListener("click", ()=>{
    if(confirm("Delete this task?")){
      tasks = tasks.filter(x=>x.id!==t.id);
      saveTasks(tasks);
      render();
    }
  });

  const actions = el("div",{class:"task-actions"},[btnComplete, btnEdit, btnDelete]);

  const side = el("div",{class:"task-side"},[
    dueLabel,
    dueInput,
    actions
  ]);

  return el("div",{class:"task-row"},[main, side]);
}

function taskRowCompleted(t){
  const titleSpan = el("span",{class:"task-title completed-title", text:t.title || "(untitled)"});
  const repeatText = (t.recurrence && t.recurrence !== "None") ? t.recurrence : "No repeat";
  const repeatPill = el("span",{class:"task-meta-pill", text:repeatText});
  const titleRow = el("div",{class:"task-title-row"},[titleSpan, repeatPill]);

  const descText = (t.description || "").trim() || "‚Äî";
  const descDiv = el("div",{class:"task-desc", text:descText});

  const dueStr = `Due: ${t.dueDate}`;
  const compStr = t.completedAt ? `Completed: ${new Date(t.completedAt).toLocaleString()}` : "Completed: -";
  const meta = el("div",{class:"completed-meta", text: `${dueStr} ‚Ä¢ ${compStr}`});

  const main = el("div",{class:"task-main"},[titleRow, descDiv, meta]);

  const btnRestore = el("button",{class:"icon-btn", title:"Restore to pending"},[document.createTextNode("üîÅ")]);
  btnRestore.addEventListener("click", ()=>{
    t.completed = false;
    t.completedAt = null;
    saveTasks(tasks);
    render();
  });

  const btnDelete = el("button",{class:"icon-btn", title:"Delete task"},[document.createTextNode("üóë")]);
  btnDelete.addEventListener("click", ()=>{
    if(confirm("Delete this task?")){
      tasks = tasks.filter(x=>x.id!==t.id);
      saveTasks(tasks);
      render();
    }
  });

  const actions = el("div",{class:"task-actions"},[btnRestore, btnDelete]);
  const side = el("div",{class:"task-side"},[actions]);

  return el("div",{class:"task-row"},[main, side]);
}

/* ========= Section helpers ========= */
function renderSection(container, arr, emptyMsg, isCompleted=false){
  container.innerHTML = "";
  if(!arr.length){
    container.appendChild(el("div",{class:"empty-text", text:emptyMsg}));
    return;
  }
  arr.forEach(t=>{
    container.appendChild(isCompleted ? taskRowCompleted(t) : taskRowPending(t));
  });
}

/* Week days under "This Week" */
function renderWeekDays(container, weekBuckets, todayISO, tomorrowISO, weekEndISO){
  container.innerHTML = "";
  const base = todayDate();
  const weekInfoSpan = $("#weekInfo");
  weekInfoSpan.textContent = `${todayISO} ‚Üí ${weekEndISO}`;

  let d = addDays(base, 2); // day after tomorrow
  let any = false;
  while (fmtDate(d) <= weekEndISO){
    const iso = fmtDate(d);
    if(iso > tomorrowISO && iso <= weekEndISO){
      const wd = d.getDay();
      const label = d.toLocaleDateString(undefined,
        {weekday:"short", month:"short", day:"numeric"});
      const dayTasks = weekBuckets[wd] || [];
      const dayTitle = el("div",{class:"section-card-sub", text:label});
      const box = el("div");
      renderSection(box, dayTasks, `No tasks for ${label}.`);
      container.appendChild(dayTitle);
      container.appendChild(box);
      any = true;
    }
    d = addDays(d,1);
  }
  if(!any){
    container.appendChild(el("div",{class:"empty-text", text:"No remaining tasks this week."}));
  }
}

/* ========= Counters ========= */
function renderCounts(){
  const base = todayDate();
  const todayISO = fmtDate(base);
  const tomorrowISO = fmtDate(addDays(base,1));
  const weekEndISO = fmtDate(weekEndSaturday(base));

  const pending = tasks.filter(t=>!t.completed);
  const cToday = pending.filter(t=>t.dueDate===todayISO).length;
  const cTom   = pending.filter(t=>t.dueDate===tomorrowISO).length;
  const cWeek  = pending.filter(t=>t.dueDate>tomorrowISO && t.dueDate<=weekEndISO).length;
  const cOver  = pending.filter(t=>t.dueDate<todayISO).length;
  const cFut   = pending.filter(t=>t.dueDate>weekEndISO).length;
  const cDone  = tasks.filter(t=>t.completed).length;

  $("#counts").innerHTML = `
    <span class="pill"><strong>Today</strong> ${cToday}</span>
    <span class="pill"><strong>Tomorrow</strong> ${cTom}</span>
    <span class="pill"><strong>This Week</strong> ${cWeek}</span>
    <span class="pill"><strong>Overdue</strong> ${cOver}</span>
    <span class="pill"><strong>Future</strong> ${cFut}</span>
    <span class="pill"><strong>Completed</strong> ${cDone}</span>
  `;
}

/* ========= Main render ========= */
function render(){
  tasks.sort((a,b)=>a.dueDate.localeCompare(b.dueDate));

  const base = todayDate();
  const todayISO = fmtDate(base);
  const tomorrowISO = fmtDate(addDays(base,1));
  const weekEndISO = fmtDate(weekEndSaturday(base));

  renderCounts();

  const pending = tasks.filter(t=>!t.completed);
  const buckets = {
    overdue: [],
    today: [],
    tomorrow: [],
    weekMap: {0:[],1:[],2:[],3:[],4:[],5:[],6:[]},
    future: []
  };

  pending.forEach(t=>{
    const iso = t.dueDate;
    if(iso < todayISO) buckets.overdue.push(t);
    else if(iso === todayISO) buckets.today.push(t);
    else if(iso === tomorrowISO) buckets.tomorrow.push(t);
    else if(iso > tomorrowISO && iso <= weekEndISO){
      const dObj = parseLocalDate(iso);
      buckets.weekMap[dObj.getDay()].push(t);
    } else if(iso > weekEndISO){
      buckets.future.push(t);
    }
  });

  ["overdue","today","tomorrow","future"].forEach(k=>{
    buckets[k].sort((a,b)=>a.dueDate.localeCompare(b.dueDate));
  });
  Object.values(buckets.weekMap).forEach(arr=>arr.sort((a,b)=>a.dueDate.localeCompare(b.dueDate)));

  renderSection($("#today"), buckets.today, "No tasks today.");
  renderSection($("#tomorrow"), buckets.tomorrow, "No tasks tomorrow.");
  renderWeekDays($("#weekDays"), buckets.weekMap, todayISO, tomorrowISO, weekEndISO);
  renderSection($("#overdue"), buckets.overdue, "No overdue tasks üéâ");
  renderSection($("#future"), buckets.future, "No future tasks üéâ");

  renderCompleted();
}

/* ========= Completed ========= */
function renderCompleted(){
  const cont = $("#completedList");
  cont.innerHTML = "";

  const done = tasks.filter(t=>t.completed).sort((a,b)=>a.dueDate.localeCompare(b.dueDate));
  renderSection(cont, done, "No completed tasks yet.", true);
}

/* ========= Edit dialog ========= */
function openEditDialog(t){
  const overlay = el("div",{style:"position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;z-index:50"});
  const card = el("div",{style:"background:#ffffff;border-radius:14px;max-width:520px;width:93%;padding:14px 14px 12px;border:1px solid #e5e7eb;box-shadow:0 20px 50px rgba(15,23,42,.45)"});
  const title = el("div",{style:"font-size:.9rem;font-weight:600;margin-bottom:6px", text:"Edit Task"});

  const form = el("div",{style:"display:grid;grid-template-columns:1fr;gap:8px"});

  const inTitle = el("input",{
    type:"text",
    value:t.title,
    placeholder:"Title",
    style:"padding:8px 9px;border-radius:999px;border:1px solid #e5e7eb"
  });
  const inDesc = el("textarea",{
    placeholder:"Description",
    style:"padding:8px 9px;border-radius:10px;border:1px solid #e5e7eb;min-height:80px;font-size:.85rem"
  });
  inDesc.value = t.description || "";

  const row = el("div",{style:"display:grid;grid-template-columns:1.1fr 1fr;gap:8px"});
  const inDue = el("input",{
    type:"date",
    value:t.dueDate,
    style:"padding:8px 9px;border-radius:999px;border:1px solid #e5e7eb"
  });
  const inRec = el("select",{
    style:"padding:8px 9px;border-radius:999px;border:1px solid #e5e7eb"
  });
  ["None","Daily","Weekly","Monthly"].forEach(opt=>{
    const o = el("option",{text:opt});
    if(opt===t.recurrence) o.selected = true;
    inRec.appendChild(o);
  });
  row.appendChild(inDue);
  row.appendChild(inRec);

  const actions = el("div",{style:"display:flex;gap:8px;justify-content:flex-end;margin-top:6px"});
  const btnSave = el("button",{class:"btn primary", text:"Save"});
  const btnCancel = el("button",{class:"btn", text:"Cancel"});

  btnSave.addEventListener("click", ()=>{
    t.title = inTitle.value.trim();
    t.description = inDesc.value.trim();
    t.dueDate = inDue.value || t.dueDate;
    t.recurrence = inRec.value || "None";
    saveTasks(tasks);
    document.body.removeChild(overlay);
    render();
  });
  btnCancel.addEventListener("click", ()=>document.body.removeChild(overlay));

  form.appendChild(inTitle);
  form.appendChild(inDesc);
  form.appendChild(row);
  actions.appendChild(btnCancel);
  actions.appendChild(btnSave);
  card.appendChild(title);
  card.appendChild(form);
  card.appendChild(actions);
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

/* ========= Add task from form (button + Enter) ========= */
function addTaskFromForm(){
  const titleEl = $("#newTitle");
  const descEl  = $("#newDesc");
  const dueEl   = $("#newDue");
  const recEl   = $("#newRecurrence");

  const title = titleEl.value;
  const desc  = descEl.value;
  const due   = dueEl.value || fmtDate(todayDate());
  const rec   = recEl.value;

  if(!title.trim()){
    alert("Title is required");
    titleEl.focus();
    return;
  }

  tasks.push(newTaskObj({title, description:desc, dueDate:due, recurrence:rec}));
  saveTasks(tasks);

  titleEl.value = "";
  descEl.value  = "";
  dueEl.value   = fmtDate(todayDate());
  recEl.value   = "None";

  render();
}

/* ========= Backup / Restore ========= */
function exportTasks(){
  const dataStr = JSON.stringify(tasks, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const todayISO = fmtDate(todayDate());
  a.href = url;
  a.download = `tasks-backup-${todayISO}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importTasksFromFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      if(!Array.isArray(parsed)){
        alert("Invalid backup file (expected an array).");
        return;
      }
      // naive validation: ensure objects have at least an id and title
      parsed.forEach(t=>{
        if(!t.id) t.id = crypto.randomUUID();
        if(typeof t.completed === "undefined") t.completed = false;
        if(typeof t.recurrence === "undefined") t.recurrence = "None";
      });
      tasks = parsed;
      saveTasks(tasks);
      render();
      alert("Tasks restored successfully.");
    } catch(err){
      console.error(err);
      alert("Could not read backup file.");
    }
  };
  reader.readAsText(file);
}

/* ========= Events ========= */
$("#addBtn").addEventListener("click", addTaskFromForm);

// Enter on task name => add task with today's date (if due empty)
$("#newTitle").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    addTaskFromForm();
  }
});

// Quick date chips
$("#qd-today").addEventListener("click", ()=>{
  $("#newDue").value = fmtDate(todayDate());
});
$("#qd-tomorrow").addEventListener("click", ()=>{
  $("#newDue").value = fmtDate(addDays(todayDate(),1));
});
$("#qd-weekend").addEventListener("click", ()=>{
  const sat = weekEndSaturday(todayDate());
  $("#newDue").value = fmtDate(sat);
});
$("#qd-nextweek").addEventListener("click", ()=>{
  const monNext = nextWeekMonday(todayDate());
  $("#newDue").value = fmtDate(monNext);
});

// Tabs
$$(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.getAttribute("data-tab");
    if(t==="pending"){
      $("#pendingTab").style.display = "block";
      $("#completedTab").style.display = "none";
    } else {
      $("#pendingTab").style.display = "none";
      $("#completedTab").style.display = "block";
    }
  });
});

// Backup / Restore buttons
$("#btnExport").addEventListener("click", exportTasks);
$("#btnImport").addEventListener("click", ()=>{
  $("#importFile").click();
});
$("#importFile").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(file) importTasksFromFile(file);
  e.target.value = ""; // reset so selecting same file again works
});

/* ========= Init ========= */
(function init(){
  $("#newDue").value = fmtDate(todayDate());
  render();
})();
</script>
</body>
</html>
