<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly Expenses Tracker</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- XLSX for import/export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>

  <style>
    .row-actions { display: flex; gap: .25rem; }
    .row-actions button { padding: 2px 6px; }
    #range-tools { display: flex; align-items: center; gap: .5rem; margin: 12px 0; flex-wrap: wrap; }
    #range-tools input { width: 280px; }
    #range-total { font-weight: 600; }
    td.sn { text-align: center; width: 64px; }
    th.sn { width: 64px; }
    tr.dragging { opacity: 0.5; }
  </style>

  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyucu_sZz49xoEqGagrxvJ-erq2SJBpDM",
      authDomain: "expensetracker-f57ff.firebaseapp.com",
      projectId: "expensetracker-f57ff",
      storageBucket: "expensetracker-f57ff.firebasestorage.app",
      messagingSenderId: "1034695983927",
      appId: "1:1034695983927:web:cf632c31f9089ccbc9d0b2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const DEFAULT_EXPENSES = [
      'Alectra','Enbridge','Water','Property Tax','CIBC CC','MBNA CC',
      'Tangerine CC','CT CC','CIBC Rida','CIBC LOC','Tangerine LOC',
      'CIBC LOC Sabi','Tangerine LOC Sabi','Afrida Insurance','H&A Insurance',
      'Sabi RRSP','Home Loan','Cash'
    ];

    let userId = null;

    // --- Auth state ---
    auth.onAuthStateChanged(user => {
      const tbody = document.querySelector('#expenses-table tbody');
      if (user) {
        userId = user.uid;
        document.getElementById('auth-status').innerHTML =
          `<span>Signed in as: ${user.email}</span> <button onclick="signOut()">Sign Out</button>`;
        loadExpenses();
      } else {
        userId = null;
        document.getElementById('auth-status').innerHTML = '';
        tbody.innerHTML = '<tr><td colspan="7">Please sign in to view your expenses.</td></tr>';
      }
    });

    function signUp() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => alert('Signed up successfully!'))
        .catch(err => alert('Error signing up: ' + err.message));
    }
    function signIn() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert('Error signing in: ' + err.message));
    }
    function signOut() { auth.signOut(); }

    // --- Add row ---
    function addExpense(name = '', amount = '', paid = 'no', dueDate = '', docId = '') {
      const tbody = document.querySelector('#expenses-table tbody');
      const row = document.createElement('tr');
      row.setAttribute('data-id', docId || Date.now().toString());

      row.innerHTML = `
        <td class="sn"></td>
        <td><input type="text" value="${name}" placeholder="Expense Name"></td>
        <td><input type="number" value="${amount}"></td>
        <td>
          <select>
            <option value="no" ${paid === 'no' ? 'selected' : ''}>No</option>
            <option value="yes" ${paid === 'yes' ? 'selected' : ''}>Yes</option>
          </select>
        </td>
        <td><input type="date" value="${dueDate}"></td>
        <td class="row-actions">
          <button type="button" onclick="moveRow(this, -1)">↑</button>
          <button type="button" onclick="moveRow(this, 1)">↓</button>
          <button type="button" onclick="removeExpense(this)">Remove</button>
        </td>
      `;
      tbody.appendChild(row);

      setupRowListeners(row);
      setupDragForRow(row);
      renumberAndPersistOrders();
      calculateTotals();
    }

    function setupRowListeners(row) {
      const docId = row.getAttribute('data-id');
      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', () => { saveRowToFirestore(row, docId); calculateTotals(); });
        input.addEventListener('change', () => { saveRowToFirestore(row, docId); calculateTotals(); });
      });
    }

    function saveRowToFirestore(row, docId) {
      if (!userId) return;
      const cells = row.cells;
      const data = {
        name: cells[1].querySelector('input').value.trim(),
        amount: cells[2].querySelector('input').value.trim(),
        paid: cells[3].querySelector('select').value,
        dueDate: cells[4].querySelector('input').value,
        order: Array.from(row.parentNode.children).indexOf(row)
      };
      db.collection('users').doc(userId).collection('expenses').doc(docId).set(data);
    }

    async function loadExpenses() {
      if (!userId) return;
      const expensesRef = db.collection('users').doc(userId).collection('expenses');
      const snapshot = await expensesRef.orderBy('order').get();
      const tbody = document.querySelector('#expenses-table tbody');
      tbody.innerHTML = '';

      if (snapshot.empty) {
        const batch = db.batch();
        DEFAULT_EXPENSES.forEach((name, index) => {
          const newDocRef = expensesRef.doc();
          batch.set(newDocRef, { name, amount: '', paid: 'no', dueDate: '', order: index });
        });
        await batch.commit();
        loadExpenses();
      } else {
        snapshot.forEach(doc => {
          const { name, amount, paid, dueDate } = doc.data();
          addExpense(name, amount, paid, dueDate, doc.id);
        });
      }
      calculateTotals();
    }

    async function removeExpense(button) {
      const row = button.closest('tr');
      const docId = row.getAttribute('data-id');
      if (userId && docId) {
        await db.collection('users').doc(userId).collection('expenses').doc(docId).delete();
      }
      row.remove();
      renumberAndPersistOrders();
      calculateTotals();
    }

    // --- Move / Drag ---
    function setupDragForRow(row) {
      let draggedRow = null;
      row.draggable = true;
      row.addEventListener('dragstart', () => { draggedRow = row; row.classList.add('dragging'); });
      row.addEventListener('dragend', () => { row.classList.remove('dragging'); renumberAndPersistOrders(); });
      row.addEventListener('dragover', e => {
        e.preventDefault();
        const tbody = row.parentNode;
        const rows = Array.from(tbody.children).filter(r => r !== draggedRow);
        const after = rows.find(r => e.clientY <= r.getBoundingClientRect().top + r.offsetHeight / 2);
        if (after) tbody.insertBefore(draggedRow, after); else tbody.appendChild(draggedRow);
      });
    }

    function moveRow(button, direction) {
      const row = button.closest('tr');
      const tbody = row.parentNode;
      const rows = Array.from(tbody.children);
      const idx = rows.indexOf(row);
      const targetIndex = idx + direction;
      if (targetIndex < 0 || targetIndex >= rows.length) return;
      if (direction < 0) tbody.insertBefore(row, rows[targetIndex]);
      else tbody.insertBefore(row, rows[targetIndex].nextSibling);
      renumberAndPersistOrders();
    }

    function renumberAndPersistOrders() {
      const rows = Array.from(document.querySelectorAll('#expenses-table tbody tr'));
      rows.forEach((r, i) => { r.querySelector('td.sn').textContent = (i + 1).toString(); });
      rows.forEach(r => { const docId = r.getAttribute('data-id'); saveRowToFirestore(r, docId); });
    }

    // --- Export ---
    function exportToExcel() {
      const rows = Array.from(document.querySelectorAll('#expenses-table tbody tr'));
      const data = [['S.No','Expense Type','Amount','Paid','Due Date']];
      rows.forEach(row => {
        data.push([
          row.cells[0].textContent || '',
          row.cells[1].querySelector('input')?.value || '',
          row.cells[2].querySelector('input')?.value || '',
          row.cells[3].querySelector('select')?.value || '',
          row.cells[4].querySelector('input')?.value || ''
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
      const now = new Date();
      const fileName = `${now.toLocaleString('default',{month:'short'})}_${now.getFullYear()}_expense.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    // --- Import ---
    function importFromExcel() {
      const file = document.getElementById('excel-file').files[0];
      if (!file) { alert("Please select an Excel file first."); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const header = rows.shift() || [];
        const hasSN = (header[0] && String(header[0]).toLowerCase().includes('s.no'));
        rows.forEach(r => {
          const [snMaybe, nameMaybe, amountMaybe, paidMaybe, dueMaybe] = r;
          const name = hasSN ? nameMaybe : snMaybe;
          const amount = hasSN ? amountMaybe : nameMaybe ? amountMaybe : '';
          const paid = (hasSN ? paidMaybe : r[2])?.toString().toLowerCase() === 'yes' ? 'yes' : 'no';
          const dueDate = hasSN ? dueMaybe : r[3];
          let matchedRow = null;
          Array.from(document.querySelectorAll('#expenses-table tbody tr')).forEach(row => {
            const input = row.cells[1].querySelector('input');
            if (input && input.value.trim().toLowerCase() === (name || '').toString().trim().toLowerCase()) {
              matchedRow = row;
            }
          });
          if (matchedRow) {
            matchedRow.cells[2].querySelector('input').value = amount || '';
            matchedRow.cells[3].querySelector('select').value = paid;
            matchedRow.cells[4].querySelector('input').value = dueDate || '';
            const docId = matchedRow.getAttribute('data-id');
            saveRowToFirestore(matchedRow, docId);
          } else {
            addExpense(name || '', amount || '', paid, dueDate || '');
          }
        });
        renumberAndPersistOrders();
        calculateTotals();
        alert("Imported successfully.");
      };
      reader.readAsArrayBuffer(file);
    }

    // --- Totals ---
    function calculateTotals() {
      let total = 0, paid = 0, unpaid = 0;
      const today = new Date(), soon = new Date(); soon.setDate(today.getDate() + 9);
      Array.from(document.querySelectorAll('#expenses-table tbody tr')).forEach(row => {
        const amount = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const status = row.cells[3].querySelector('select').value;
        const due = row.cells[4].querySelector('input').value;
        total += amount;
        if (status === 'yes') { paid += amount; row.style.backgroundColor = '#d4edda'; }
        else { unpaid += amount; row.style.backgroundColor = (due && new Date(due) <= soon) ? '#f8d7da' : ''; }
      });
      document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
      document.getElementById('total-paid').textContent = `$${paid.toFixed(2)} Paid`;
      document.getElementById('total-unpaid').textContent = `$${unpaid.toFixed(2)} Unpaid`;
    }

    // --- Range calculator ---
    function parseSerialExpr(expr) {
      if (!expr) return [];
      const s = expr.replace(/\s+/g, '');
      if (!s) return [];
      const set = new Set();
      s.split(',').forEach(part => {
        if (!part) return;
        if (part.includes('-')) {
          const [aStr, bStr] = part.split('-');
          const a = parseInt(aStr, 10), b = parseInt(bStr, 10);
          if (Number.isInteger(a) && Number.isInteger(b)) {
            const start = Math.min(a, b), end = Math.max(a, b);
            for (let i = start; i <= end; i++) set.add(i);
          }
        } else {
          const n = parseInt(part, 10);
          if (Number.isInteger(n)) set.add(n);
        }
      });
      return Array.from(set).sort((x,y)=>x-y);
    }
    function calcRangeUnpaid() {
      const expr = document.getElementById('range-input').value;
      const serials = parseSerialExpr(expr);
      if (!serials.length) {
        document.getElementById('range-total').textContent =
          'Enter serials like 1-10 or 1,3,5 or 2-4,7,9-11.';
        return;
      }
      const rows = Array.from(document.querySelectorAll('#expenses-table tbody tr'));
      let sum = 0;
      serials.forEach(sn => {
        const row = rows[sn-1]; if (!row) return;
        const status = row.cells[3].querySelector('select').value;
        if (status === 'no') {
          const amount = parseFloat(row.cells[2].querySelector('input').value) || 0;
          sum += amount;
        }
      });
      document.getElementById('range-total').textContent =
        `Unpaid total (S.No ${serials.join(', ')}): $${sum.toFixed(2)}`;
    }

    // expose globally
    window.addExpense = addExpense;
    window.removeExpense = removeExpense;
    window.moveRow = moveRow;
    window.exportToExcel = exportToExcel;
    window.importFromExcel = importFromExcel;
    window.calcRangeUnpaid = calcRangeUnpaid;
  </script>
</head>
<body>
  <header>
    <h1>Monthly Expenses Tracker</h1>
    <nav><a href="index.html">Home</a></nav>
    <div id="auth-buttons">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="signUp()">Sign Up</button>
      <button onclick="signIn()">Sign In</button>
      <button class="button" onclick="exportToExcel()">Export to Excel</button>
      <input type="file" id="excel-file" accept=".xlsx, .xls" />
      <button class="button" onclick="importFromExcel()">Import from Excel</button>
    </div>
    <div id="auth-status"></div>
  </header>

  <main>
    <div style="margin: 20px 0;">
      <button onclick="addExpense()">Add New Expense</button>
    </div>

    <!-- Range total calculator -->
    <div id="range-tools">
      <span><strong>Range total (Unpaid only):</strong></span>
      <input type="text" id="range-input"
        placeholder="e.g. 1-10 or 1,3,5 or 2-4,7,9-11"
        onkeydown="if (event.key === 'Enter') { calcRangeUnpaid(); }"/>
      <button type="button" onclick="calcRangeUnpaid()">Calculate</button>
      <span id="range-total"></span>
    </div>

    <table id="expenses-table">
      <thead>
        <tr>
          <th class="sn">S.No</th>
          <th>Expense Type</th>
          <th>Amount ($)</th>
          <th>Paid?</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td><strong>Total</strong></td>
          <td id="total-amount">$0.00</td>
          <td id="total-paid">$
