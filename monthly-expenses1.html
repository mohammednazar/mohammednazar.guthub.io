<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Monthly Expenses Tracker</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  margin: 0;
}

header {
  background: #1f2937;
  color: white;
  padding: 15px;
}

main { padding: 20px; }

button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 7px 14px;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  background: #1e40af;
}

input[type="file"], input[type="email"], input[type="password"] {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

th {
  background: #e5e7eb;
}

tfoot td {
  font-weight: bold;
  background: #f3f4f6;
}

td.sn {
  text-align: center;
  width: 60px;
}
</style>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

/* ðŸ”¥ CRITICAL â€” session retained after refresh */
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let userId = null;

function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

/* ================= AUTH ================= */

function signUp() {
  const email = qs('#email').value;
  const password = qs('#password').value;

  auth.createUserWithEmailAndPassword(email, password)
    .catch(err => alert(err.message));
}

function signIn() {
  const email = qs('#email').value;
  const password = qs('#password').value;

  auth.signInWithEmailAndPassword(email, password)
    .catch(err => alert(err.message));
}

function signOut() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  if (user) {
    userId = user.uid;
    qs('#auth-status').textContent = "Logged in as: " + user.email;
    loadExpenses();
  } else {
    userId = null;
    qs('#auth-status').textContent = "Not signed in";
    qs('#expenses-table tbody').innerHTML =
      '<tr><td colspan="6">Please sign in.</td></tr>';
  }
});

/* ================= EXPENSE LOGIC ================= */

function addExpense(name='', amount='', paid='no', dueDate='', docId=''){
  const tbody = qs('#expenses-table tbody');
  const row = document.createElement('tr');
  row.setAttribute('data-id', docId || Date.now().toString());

  row.innerHTML = `
    <td class="sn"></td>
    <td><input type="text" value="${name}"></td>
    <td><input type="number" value="${amount}"></td>
    <td>
      <select>
        <option value="no" ${paid==='no'?'selected':''}>No</option>
        <option value="yes" ${paid==='yes'?'selected':''}>Yes</option>
      </select>
    </td>
    <td><input type="date" value="${dueDate}"></td>
    <td><button onclick="removeExpense(this)">Remove</button></td>
  `;

  tbody.appendChild(row);
  setupListeners(row);
  renumberRows();
}

function setupListeners(row){
  const docId = row.getAttribute('data-id');

  row.querySelectorAll('input, select').forEach(input=>{
    input.addEventListener('change', ()=>{
      saveRowToFirestore(row, docId);
      calculateTotals();
    });
  });
}

function saveRowToFirestore(row, docId){
  if(!userId) return;

  const cells = row.cells;

  const data = {
    name: cells[1].querySelector('input').value.trim(),
    amount: cells[2].querySelector('input').value.trim(),
    paid: cells[3].querySelector('select').value,
    dueDate: cells[4].querySelector('input').value,
    order: Array.from(row.parentNode.children).indexOf(row)
  };

  db.collection('users')
    .doc(userId)
    .collection('expenses')
    .doc(docId)
    .set(data);
}

async function loadExpenses(){
  if(!userId) return;

  const snapshot = await db.collection('users')
    .doc(userId)
    .collection('expenses')
    .orderBy('order')
    .get();

  qs('#expenses-table tbody').innerHTML = '';

  snapshot.forEach(doc=>{
    const {name, amount, paid, dueDate} = doc.data();
    addExpense(name, amount, paid, dueDate, doc.id);
  });

  renumberRows();

  setTimeout(()=>{
    calculateTotals();
  },50);
}

function removeExpense(btn){
  const row = btn.closest('tr');
  const docId = row.getAttribute('data-id');

  if(userId && docId){
    db.collection('users')
      .doc(userId)
      .collection('expenses')
      .doc(docId)
      .delete();
  }

  row.remove();
  renumberRows();
  calculateTotals();
}

function renumberRows(){
  qsa('#expenses-table tbody tr').forEach((r,i)=>{
    r.querySelector('.sn').textContent = i+1;
  });
}

/* ================= TOTAL + HIGHLIGHT ================= */

function calculateTotals(){
  let total=0, paid=0, unpaid=0;

  const today = new Date();
  today.setHours(0,0,0,0);

  const soon = new Date();
  soon.setDate(today.getDate()+10);

  qsa('#expenses-table tbody tr').forEach(row=>{
    const amount=parseFloat(row.cells[2].querySelector('input').value)||0;
    const status=row.cells[3].querySelector('select').value;
    const due=row.cells[4].querySelector('input').value;

    total+=amount;
    row.style.backgroundColor='';

    if(status==='yes'){
      paid+=amount;
      row.style.backgroundColor='#d4edda';
    } else {
      unpaid+=amount;

      if(due){
        const dueDate=new Date(due);
        dueDate.setHours(0,0,0,0);

        if(dueDate>=today && dueDate<=soon){
          row.style.backgroundColor='#f8d7da';
        }
      }
    }
  });

  qs('#total-amount').textContent=`$${total.toFixed(2)}`;
  qs('#total-paid').textContent=`$${paid.toFixed(2)} Paid`;
  qs('#total-unpaid').textContent=`$${unpaid.toFixed(2)} Unpaid`;

  applyPaidFilter();
}

/* ================= FILTER ================= */

function applyPaidFilter(){
  const filterValue=qs('#paid-filter').value;

  qsa('#expenses-table tbody tr').forEach(row=>{
    const status=row.cells[3].querySelector('select').value;
    row.style.display=(filterValue==='all'||status===filterValue)?'':'none';
  });
}

/* ================= EXCEL ================= */

function exportToExcel(){
  const rows=qsa('#expenses-table tbody tr');
  const data=[['S.No','Expense Type','Amount','Paid','Due Date']];

  rows.forEach(row=>{
    data.push([
      row.cells[0].textContent,
      row.cells[1].querySelector('input').value,
      row.cells[2].querySelector('input').value,
      row.cells[3].querySelector('select').value,
      row.cells[4].querySelector('input').value
    ]);
  });

  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Expenses');
  XLSX.writeFile(wb,'Expenses.xlsx');
}

function importFromExcel(){
  const file=qs('#excel-file').files[0];
  if(!file){ alert("Select file first"); return; }

  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    rows.shift();

    rows.forEach(r=>{
      addExpense(r[1], r[2], r[3], r[4]);
    });

    calculateTotals();
  };
  reader.readAsArrayBuffer(file);
}
</script>
</head>

<body>

<header>
<h1>Monthly Expenses Tracker</h1>

<div style="margin-top:10px;">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
  <button onclick="signOut()">Sign Out</button>
</div>

<div id="auth-status" style="margin-top:8px;"></div>
</header>

<main>

<div style="margin-bottom:15px;">
  <button onclick="addExpense()">Add New Expense</button>
  <button onclick="exportToExcel()">Export to Excel</button>
  <input type="file" id="excel-file" accept=".xlsx,.xls">
  <button onclick="importFromExcel()">Import from Excel</button>
</div>

<div style="margin-bottom:15px;">
  <label><strong>Filter by Paid:</strong></label>
  <select id="paid-filter" onchange="applyPaidFilter()">
    <option value="all">All</option>
    <option value="yes">Yes (Paid)</option>
    <option value="no">No (Unpaid)</option>
  </select>
</div>

<table id="expenses-table">
<thead>
<tr>
<th class="sn">S.No</th>
<th>Expense Type</th>
<th>Amount ($)</th>
<th>Paid?</th>
<th>Due Date</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td>Total</td>
<td id="total-amount">$0.00</td>
<td id="total-paid">$0.00 Paid</td>
<td id="total-unpaid">$0.00 Unpaid</td>
<td colspan="2"></td>
</tr>
</tfoot>
</table>

</main>
</body>
</html>
