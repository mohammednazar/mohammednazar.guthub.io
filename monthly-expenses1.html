<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly Expenses Tracker</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- XLSX for import/export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>

  <style>
    .row-actions { display: flex; gap: .25rem; }
    .row-actions button { padding: 2px 6px; }
    #range-tools { display: flex; align-items: center; gap: .5rem; margin: 12px 0; flex-wrap: wrap; }
    #range-tools input { width: 280px; }
    #range-total { font-weight: 600; }
    td.sn { text-align: center; width: 64px; }
    th.sn { width: 64px; }
    tr.dragging { opacity: 0.5; }
    #defaults-buttons { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: 8px; }
  </style>

  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyucu_sZz49xoEqGagrxvJ-erq2SJBpDM",
      authDomain: "expensetracker-f57ff.firebaseapp.com",
      projectId: "expensetracker-f57ff",
      storageBucket: "expensetracker-f57ff.firebasestorage.app",
      messagingSenderId: "1034695983927",
      appId: "1:1034695983927:web:cf632c31f9089ccbc9d0b2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- YOUR ORIGINAL DEFAULT LIST (restored) ---
    const DEFAULT_EXPENSES = [
      'Alectra', 'Enbridge', 'Water', 'Property Tax', 'CIBC CC', 'MBNA CC',
      'Tangerine CC', 'CT CC', 'CIBC Rida', 'CIBC LOC', 'Tangerine LOC',
      'CIBC LOC Sabi', 'Tangerine LOC Sabi', 'Afrida Insurance', 'H&A Insurance',
      'Sabi RRSP', 'Home Loan', 'Cash'
    ];

    let userId = null;

    // --- Auth state ---
    auth.onAuthStateChanged(user => {
      const tbody = document.querySelector('#expenses-table tbody');
      if (user) {
        userId = user.uid;
        document.getElementById('auth-status').innerHTML =
          `<span>Signed in as: ${user.email}</span> <button onclick="signOut()">Sign Out</button>`;
        loadExpenses();
      } else {
        userId = null;
        document.getElementById('auth-status').innerHTML = '';
        tbody.innerHTML = '<tr><td colspan="7">Please sign in to view your expenses.</td></tr>';
      }
    });

    function signUp() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => alert('Signed up successfully!'))
        .catch(err => alert('Error signing up: ' + err.message));
    }
    function signIn() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert('Error signing in: ' + err.message));
    }
    function signOut() { auth.signOut(); }

    // --- Add row ---
    function addExpense(name = '', amount = '', paid = 'no', dueDate = '', docId = '') {
      const tbody = document.querySelector('#expenses-table tbody');
      const row = document.createElement('tr');
      row.setAttribute('data-id', docId || Date.now().toString());

      row.innerHTML = `
        <td class="sn"></td>
        <td><input type="text" value="${name}" placeholder="Expense Name"></td>
        <td><input type="number" value="${amount}"></td>
        <td>
          <select>
            <option value="no" ${paid === 'no' ? 'selected' : ''}>No</option>
            <option value="yes" ${paid === 'yes' ? 'selected' : ''}>Yes</option>
          </select>
        </td>
        <td><input type="date" value="${dueDate}"></td>
        <td class="row-actions">
          <button type="button" onclick="moveRow(this, -1)">↑</button>
          <button type="button" onclick="moveRow(this, 1)">↓</button>
          <button type="button" onclick="removeExpense(this)">Remove</button>
        </td>
      `;
      tbody.appendChild(row);

      setupRowListeners(row);
      setupDragForRow(row);
      renumberAndPersistOrders();
      calculateTotals();
    }

    function setupRowListeners(row) {
      const docId = row.getAttribute('data-id');
      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', () => { saveRowToFirestore(row, docId); calculateTotals(); });
        input.addEventListener('change', () => { saveRowToFirestore(row, docId); calculateTotals(); });
      });
    }

    function saveRowToFirestore(row, docId) {
      if (!userId) return;
      const cells = row.cells;
      const data = {
        name: cells[1].querySelector('input').value.trim(),
        amount: cells[2].querySelector('input').value.trim(),
        paid: cells[3].querySelector('select').value,
        dueDate: cells[4].querySelector('input').value,
        order: Array.from(row.parentNode.children).indexOf(row)
      };
      db.collection('users').doc(userId).collection('expenses').doc(docId).set(data);
    }

    async function loadExpenses() {
      if (!userId) return;
      const expensesRef = db.collection('users').doc(userId).collection('expenses');
      const snapshot = await expensesRef.orderBy('order').get();
      const tbody = document.querySelector('#expenses-table tbody');
      tbody.innerHTML = '';

      if (snapshot.empty) {
        // Seed defaults if empty
        const batch = db.batch();
        DEFAULT_EXPENSES.forEach((name, index) => {
          const newDocRef = expensesRef.doc();
          batch.set(newDocRef, { name, amount: '', paid: 'no', dueDate: '', order: index });
        });
        await batch.commit();
        const snap2 = await expensesRef.orderBy('order').get();
        snap2.forEach(doc => {
          const { name, amount, paid, dueDate } = doc.data();
          addExpense(name, amount, paid, dueDate, doc.id);
        });
      } else {
        snapshot.forEach(doc => {
